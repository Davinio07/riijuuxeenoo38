# =========================================================
# GLOBAL CONFIGURATION
# =========================================================
# Use a reliable Java 21 image
image: maven:3.9.6-eclipse-temurin-21

stages:
  - build
  - test
  - build_docs
  - deploy # CRITICAL: The deployment stage is defined

# =========================================================
# GLOBAL CACHING DEFINITION
# This caches the entire Maven local repository (.m2) across jobs and runs
# =========================================================
cache:
  paths:
    # This caches the Maven dependencies/plugins to solve the 'Plugin not found' error.
    - /root/.m2/repository/

# =========================================================
# APPLICATION BUILD AND TEST STAGES
# =========================================================

build_app:
  stage: build
  tags:
    - hva
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

test_app:
  stage: test
  tags:
    - hva
  script:
    - cd backend
    - mvn test -Dspring.datasource.url=jdbc:h2:mem:testdb -Dspring.datasource.driverClassName=org.h2.Driver -Dspring.datasource.username=sa -Dspring.datasource.password=

# =========================================================
# DOCUMENTATION BUILD STAGE (Javadoc Only)
# =========================================================

build_javadoc:
  stage: build_docs
  tags:
    - hva
  script:
    - echo "Generating Javadoc with verbose errors into docs/apidocs..."
    # This command relies on the maven-javadoc-plugin configured in backend/pom.xml
    - cd backend
    - mvn javadoc:javadoc -e

  artifacts:
    name: javadoc_artifact
    paths:
      # This path is correct, assuming you configured backend/pom.xml to output here.
      - docs/apidocs
    expire_in: 1 day


# =========================================================
# DEPLOYMENT STAGE (GitLab Pages)
# =========================================================
# CRITICAL: This job MUST be named 'pages'
pages:
  stage: deploy
  tags:
    - hva
  dependencies:
    - build_javadoc # Fetches the Javadoc artifact from the previous job

  script:
    - echo "Deploying Javadoc to GitLab Pages public/ directory..."

    # 1. Create the mandatory 'public' directory
    - mkdir public

    # 2. Move the Javadoc artifact contents into the public folder
    - mv docs/apidocs/* public/

  # CRITICAL: The Pages artifact MUST be the 'public' folder
  artifacts:
    paths:
      - public

  rules:
    # This rule restricts deployment to the default branch (e.g., 'main' or 'master')
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH