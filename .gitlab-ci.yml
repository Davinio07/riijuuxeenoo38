stages:
  - build
  - publish
  - deploy

variables:
  # We gebruiken de tag 'latest' voor het gemak
  DOCKER_IMAGE: "$DOCKER_USERNAME/election-backend:latest"

# FASE 1: Java Applicatie Bouwen (Blijft hetzelfde)
build-backend:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build
  tags:
    - hva
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

# FASE 2: Docker Image Bouwen met KANIKO (De Fix!)
publish-image:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  tags:
    - hva
  only:
    - main
  script:
    - echo "âš™ï¸ Configureren van Docker credentials..."
    - mkdir -p /kaniko/.docker
    # Hier maken we een config file met jouw gebruikersnaam en wachtwoord
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(printf "%s:%s" "${DOCKER_USERNAME}" "${DOCKER_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    
    - echo "ðŸ³ Start bouwen en pushen van image..."
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/backend"
      --dockerfile "${CI_PROJECT_DIR}/backend/Dockerfile"
      --destination "${DOCKER_IMAGE}"
      --destination "${DOCKER_USERNAME}/election-backend:v1"  # Pushed ook als v1 voor de zekerheid

# FASE 3: Deployen op Oege (Blijft hetzelfde)
deploy-to-oege:
  stage: deploy
  image: alpine:latest
  tags:
    - hva
  only:
    - main
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Start deployment naar Oege..."
    - ssh $SSH_USER@$SSH_HOST "
        echo '1. Nieuwe image ophalen...';
        docker pull $DOCKER_IMAGE &&
        
        echo '2. Oude container stoppen en verwijderen...';
        docker stop election-backend || true &&
        docker rm election-backend || true &&
        
        echo '3. RUIMTE MAKEN...';
        docker system prune -a -f &&
        
        echo '4. Nieuwe container starten...';
        docker run -d 
          --restart=always 
          --name election-backend 
          -p 8400:8080 
          -e SPRING_PROFILES_ACTIVE=production 
          -e DB_PASSWORD=$DB_PASSWORD 
          -v /home/ivi/suham1/verkiezingsdata:/app/data 
          $DOCKER_IMAGE"
    - echo "âœ… Deployment geslaagd!"