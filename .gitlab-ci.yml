stages:
  - build
  - publish
  - deploy

variables:
  DOCKER_IMAGE: "$DOCKER_USERNAME/election-backend:latest"

# FASE 1: Altijd bouwen (om te testen of de code werkt)
build-backend:
  image: maven:3.9.6-eclipse-temurin-21
  stage: build
  tags:
    - hva
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

# FASE 2: Alleen publiceren als we op 'main' zitten
publish-image:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  tags:
    - hva
  only:          # <--- TOEVOEGEN
    - main       # <--- TOEVOEGEN
  before_script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  script:
    - cd backend
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE

# FASE 3: Alleen deployen als we op 'main' zitten
deploy-to-oege:
  stage: deploy
  image: alpine:latest
  tags:
    - hva
  only:          # <--- TOEVOEGEN
    - main       # <--- TOEVOEGEN
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Start deployment naar Oege..."
    - ssh $SSH_USER@$SSH_HOST "
        docker pull $DOCKER_IMAGE &&
        docker stop election-backend || true &&
        docker rm election-backend || true &&
        docker system prune -a -f &&
        docker run -d 
          --restart=always 
          --name election-backend 
          -p 8400:8080 
          -e SPRING_PROFILES_ACTIVE=production 
          -e DB_PASSWORD=$DB_PASSWORD 
          -v /home/ivi/suham1/verkiezingsdata:/app/data 
          $DOCKER_IMAGE"