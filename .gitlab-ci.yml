# =========================================================
# GLOBAL CONFIGURATION
# =========================================================
# Use a reliable Java 21 image
image: maven:3.9.6-eclipse-temurin-21

stages:
  - build
  - test
  - build_docs
  - deploy

# =========================================================
# GLOBAL CACHING DEFINITION
# This caches the entire Maven local repository (.m2) across jobs and runs
# =========================================================
cache:
  paths:
    # CRITICAL: This path tells GitLab to save and restore the Maven repository
    - /root/.m2/repository/

# =========================================================
# APPLICATION BUILD AND TEST STAGES
# =========================================================

build_app:
  stage: build
  tags:
    - hva
  # This job will download dependencies and populate the cache.
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

test_app:
  stage: test
  tags:
    - hva
  script:
    - cd backend
    - mvn test -Dspring.datasource.url=jdbc:h2:mem:testdb -Dspring.datasource.driverClassName=org.h2.Driver -Dspring.datasource.username=sa -Dspring.datasource.password=

# =========================================================
# DOCUMENTATION BUILD STAGE (Javadoc Only)
# =========================================================

build_javadoc:
  stage: build_docs
  tags:
    - hva
  # No 'dependencies' needed, as caching handles persistence
  script:
    - echo "Generating Javadoc with verbose errors into docs/apidocs..."
    # The cache from 'build_app' is automatically used here.
    - cd backend
    - mvn javadoc:javadoc -e

  artifacts:
    name: javadoc_artifact
    paths:
      # Requires pom.xml configured for this path
      - docs/apidocs
    expire_in: 1 day


# =========================================================
# DEPLOYMENT STAGE (GitLab Pages)
# =========================================================
pages:
  stage: deploy
  tags:
    - hva
  dependencies:
    - build_javadoc # Fetch the Javadoc artifact

  script:
    - echo "Deploying Javadoc to GitLab Pages public/ directory..."

    # 1. Create the mandatory 'public' directory
    - mkdir public

    # 2. Move the Javadoc content from the artifact (docs/apidocs) into public/
    - mv docs/apidocs/* public/

  # This job MUST define 'public' as an artifact path
  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH