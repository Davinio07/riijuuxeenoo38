# =========================================================
# GLOBAL CONFIGURATION
# =========================================================
image: maven:3.9.6-eclipse-temurin-21

variables:
  DOCKER_IMAGE: "$DOCKER_USERNAME/election-backend:latest"

# Global rule: Everything in this file only runs on the main branch
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

stages:
  - build
  - test
  - build_docs
  - publish
  - deploy

# =========================================================
# 1. BUILD & TEST STAGE
# =========================================================

build_app:
  stage: build
  tags:
    - hva
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

test_app:
  stage: test
  tags:
    - hva
  script:
    - cd backend
    - mvn test -Dspring.datasource.url=jdbc:h2:mem:testdb -Dspring.datasource.driverClassName=org.h2.Driver -Dspring.datasource.username=sa -Dspring.datasource.password=

# =========================================================
# 2. DOCUMENTATION STAGE
# =========================================================

build_javadoc:
  stage: build_docs
  tags:
    - hva
  script:
    - cd backend
    - mvn javadoc:javadoc -e
  artifacts:
    paths:
      - docs/apidocs
    expire_in: 1 day

# =========================================================
# 3. PUBLISH STAGE (Docker)
# =========================================================

publish-image:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  tags:
    - hva
  before_script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  script:
    - cd backend
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE

# =========================================================
# 4. DEPLOY STAGE (Pages & Oege Server)
# =========================================================

# Deploy Javadoc to GitLab Pages
pages:
  stage: deploy
  tags:
    - hva
  dependencies:
    - build_javadoc
  script:
    - mkdir public
    - mv docs/apidocs/* public/
  artifacts:
    paths:
      - public

# Deploy Backend to Oege Server
deploy-to-oege:
  stage: deploy
  image: alpine:latest
  tags:
    - hva
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Start deployment naar Oege..."
    - ssh $SSH_USER@$SSH_HOST "
      docker pull $DOCKER_IMAGE &&
      docker stop election-backend || true &&
      docker rm election-backend || true &&
      docker system prune -a -f &&
      docker run -d
      --restart=always
      --name election-backend
      -p 8400:8080
      -e SPRING_PROFILES_ACTIVE=production
      -e DB_PASSWORD=$DB_PASSWORD
      -v /home/ivi/suham1/verkiezingsdata:/app/data
      $DOCKER_IMAGE"