# =========================================================
# GLOBAL CONFIGURATION
# =========================================================
# Use a reliable Java 21 image
image: maven:3.9.6-eclipse-temurin-21 # Use a Maven-specific image to avoid manual setup

stages:
  - build
  - test
  - build_docs
  - deploy

# NOTE: Removed the before_script for Maven installation, as the 'maven' image
# already includes Maven and Java.

# =========================================================
# APPLICATION BUILD AND TEST STAGES (Keep as is, adjusted image)
# =========================================================

build_app:
  stage: build
  tags:
    - hva
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

test_app:
  stage: test
  tags:
    - hva
  script:
    - cd backend
    - mvn test -Dspring.datasource.url=jdbc:h2:mem:testdb -Dspring.datasource.driverClassName=org.h2.Driver -Dspring.datasource.username=sa -Dspring.datasource.password=

# =========================================================
# DOCUMENTATION BUILD STAGE (Javadoc Only)
# =========================================================

build_javadoc:
  stage: build_docs
  tags:
    - hva
  # Use the default Java/Maven image
  script:
    - echo "Generating Javadoc..."
    - cd backend
    # Recommended goal for generating Javadoc.
    # The output is typically 'target/site/apidocs' relative to the pom.xml location.
    - mvn javadoc:javadoc

  artifacts:
    name: javadoc_artifact
    # Path is relative to the *project root* (where .gitlab-ci.yml is).
    # Since mvn was run inside 'backend/', the path is 'backend/target/site/apidocs'.
    paths:
      - backend/target/site/apidocs
    expire_in: 1 day # Reduced expiration for generated files

# =========================================================
# DEPLOYMENT STAGE (GitLab Pages)
# =========================================================
pages:
  stage: deploy
  # This job must use the same image as the job that created the artifacts,
  # or an image that can correctly handle the files.
  # Using the default image is safest here.
  # The tags must also match if you are using specific runners.
  tags:
    - hva
  # Dependencies are relative to the *CI job name*
  dependencies:
    - build_javadoc

  script:
    - echo "Deploying Javadoc to GitLab Pages public/ directory..."

    # 1. Ensure the mandatory 'public' directory is created at the CI root
    - mkdir public

    # 2. Find the Javadoc output directory created by the artifact.
    # When artifacts are fetched, they are placed in their original paths relative
    # to the CI root. The Javadoc is in 'backend/target/site/apidocs'.
    # We must move the *contents* of that directory into the 'public' folder.
    - mv backend/target/site/apidocs/* public/

  # This job MUST define 'public' as an artifact path
  artifacts:
    paths:
      - public

  # Rules for deployment
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH